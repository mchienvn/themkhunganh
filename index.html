<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình Chỉnh Sửa Ảnh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ms+Madi&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: #f8fafc;
        }
        .control-panel button, .control-panel input, .control-panel select {
            transition: all 0.2s ease;
        }
        .control-panel button:hover {
            background-color: #0369a1;
        }
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        input[type="range"]:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #canvas-wrapper {
            width: 100%;
            height: auto;
            transition: aspect-ratio 0.3s ease-in-out;
        }
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body class="text-slate-800">

    <!-- Admin Controls Area -->
    <div class="absolute top-4 right-4 z-30 flex items-center gap-2">
        <button id="admin-btn" class="bg-slate-700 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-slate-800 transition-colors">
            Admin
        </button>
        <div id="admin-controls" class="hidden items-center gap-2">
            <select id="admin-font-select" class="bg-white border border-slate-300 rounded-lg p-2 text-sm"></select>
            <button id="admin-upload-frame-btn" class="bg-indigo-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-indigo-700 text-sm">Tải Khung</button>
            <input type="file" id="admin-frame-uploader" class="hidden" accept="image/png">
            <button id="admin-add-link-btn" class="bg-cyan-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-cyan-700 text-sm">Thêm Link</button>
            <button id="admin-upload-font-btn" class="bg-purple-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-purple-700 text-sm">Tải Font</button>
            <input type="file" id="admin-font-uploader" class="hidden" accept=".ttf,.woff,.woff2">
        </div>
    </div>

    <!-- Password Modal -->
    <div id="password-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 hidden opacity-0">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-4">Nhập Mật khẩu Admin</h2>
            <input type="password" id="password-input" class="w-full p-2 border border-slate-300 rounded-lg mb-4" placeholder="****">
            <p id="password-error" class="text-red-500 text-sm mb-4 hidden">Mật khẩu không đúng. Vui lòng thử lại.</p>
            <div class="flex justify-end space-x-4">
                <button id="password-cancel" class="bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg">Hủy</button>
                <button id="password-submit" class="bg-sky-600 text-white font-bold py-2 px-4 rounded-lg">Xác nhận</button>
            </div>
        </div>
    </div>
    
    <!-- Add Link Modal -->
    <div id="link-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 hidden opacity-0">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-4">Thêm Khung ảnh từ Link</h2>
            <div class="space-y-4">
                <div>
                    <label for="link-name-input" class="block text-sm font-medium text-slate-700 mb-1">Tên Khung ảnh</label>
                    <input type="text" id="link-name-input" class="w-full p-2 border border-slate-300 rounded-lg" placeholder="Ví dụ: Khung Polaroid Mới">
                </div>
                <div>
                    <label for="link-url-input" class="block text-sm font-medium text-slate-700 mb-1">Link ảnh công khai (.png)</label>
                    <input type="url" id="link-url-input" class="w-full p-2 border border-slate-300 rounded-lg" placeholder="https://i.ibb.co/...">
                </div>
                 <p id="link-error" class="text-red-500 text-sm hidden">Vui lòng nhập đầy đủ thông tin.</p>
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="link-cancel" class="bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg">Hủy</button>
                <button id="link-submit" class="bg-sky-600 text-white font-bold py-2 px-4 rounded-lg">Thêm</button>
            </div>
        </div>
    </div>



    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Trình Chỉnh Sửa Ảnh</h1>
            <p class="mt-2 text-lg text-slate-600">Tải ảnh, chọn khung và thêm thông điệp của bạn.</p>
        </header>

        <main id="app-content">
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <!-- Control Panel -->
                <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                    <div class="control-panel space-y-4">
                         <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">1. Tải ảnh của bạn</label>
                                <button id="fabric-image-loader-btn" class="w-full bg-sky-600 text-white font-bold py-2 px-4 rounded-lg">Tải ảnh</button>
                                <input type="file" id="fabric-image-loader" class="hidden" accept="image/*">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">2. Chọn khung có sẵn</label>
                                <select id="fabric-frame-select" class="w-full p-2.5 border border-slate-300 rounded-lg bg-white"></select>
                            </div>
                        </div>
                        <div id="fabric-image-sliders" class="space-y-3 pt-4 border-t border-slate-200">
                            <h3 class="text-md font-semibold text-slate-800">Điều khiển Ảnh nền</h3>
                            <div>
                                <label for="fabric-zoom-slider" class="block text-sm font-medium text-slate-700">Phóng to/Thu nhỏ: <span id="fabric-zoom-value">100</span>%</label>
                                <input type="range" id="fabric-zoom-slider" min="100" max="500" value="100" class="w-full" disabled>
                            </div>
                            <div>
                                <label for="fabric-x-slider" class="block text-sm font-medium text-slate-700">Vị trí Trục X</label>
                                <input type="range" id="fabric-x-slider" min="0" max="100" value="50" class="w-full" disabled>
                            </div>
                            <div>
                                <label for="fabric-y-slider" class="block text-sm font-medium text-slate-700">Vị trí Trục Y</label>
                                <input type="range" id="fabric-y-slider" min="0" max="100" value="50" class="w-full" disabled>
                            </div>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-4 pt-4 border-t border-slate-200">
                            <input type="text" id="fabric-text-input" placeholder="3. Nhập văn bản..." class="flex-grow p-2 border border-slate-300 rounded-lg">
                            <button id="fabric-add-text-btn" class="bg-sky-600 text-white font-bold py-2 px-4 rounded-lg">Thêm</button>
                        </div>
                        <div id="fabric-text-sliders" class="space-y-3 pt-4 border-t border-slate-200">
                            <h3 class="text-md font-semibold text-slate-800">Điều khiển Văn bản</h3>
                            <div>
                                <label for="fabric-text-size-slider" class="block text-sm font-medium text-slate-700">Cỡ chữ: <span id="fabric-text-size-value">48</span>px</label>
                                <input type="range" id="fabric-text-size-slider" min="12" max="120" value="48" class="w-full" disabled>
                            </div>
                            <div>
                                <label for="fabric-text-x-slider" class="block text-sm font-medium text-slate-700">Vị trí Trục X</label>
                                <input type="range" id="fabric-text-x-slider" min="-300" max="300" value="0" class="w-full" disabled>
                            </div>
                            <div>
                                <label for="fabric-text-y-slider" class="block text-sm font-medium text-slate-700">Vị trí Trục Y</label>
                                <input type="range" id="fabric-text-y-slider" min="-300" max="300" value="0" class="w-full" disabled>
                            </div>
                        </div>
                         <div class="mt-4 pt-4 border-t border-slate-200 grid grid-cols-2 gap-4">
                            <button id="share-btn" class="w-full bg-teal-600 text-white font-bold py-2 px-4 rounded-lg">Lưu & Chia sẻ</button>
                            <button id="fabric-download-btn" class="w-full bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg">Tải xuống</button>
                        </div>
                    </div>
                </div>
                <!-- Canvas Preview -->
                <div class="lg:col-span-3 bg-white p-6 rounded-lg shadow-md flex items-center justify-center">
                    <div id="canvas-wrapper" class="bg-slate-100 rounded-md p-2">
                        <canvas id="fabricCanvas"></canvas>
                    </div>
                </div>
            </div>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- Data: Predefined frames from a CORS-friendly host ---
    let frames = [
        { name: "Chọn một khung...", url: "" },
        { name: "Không có khung", url: "" },
        { name: "Khung thử nghiệm", url: "https://i.ibb.co/YTfRKsvr/test.png" }
    ];
    
    let availableFonts = [
        { name: 'Ms Madi', value: '"Ms Madi"' },
        { name: 'Be Vietnam Pro', value: '"Be Vietnam Pro"' }
    ];

    // --- Preload frame images for faster switching ---
    frames.forEach(frame => {
        if (frame.url) {
            const img = new Image();
            img.src = frame.url;
        }
    });

    // --- Populate frame selectors ---
    const fabricFrameSelect = document.getElementById('fabric-frame-select');
    function populateFrames() {
        fabricFrameSelect.innerHTML = '';
        frames.forEach(frame => {
            const option = new Option(frame.name, frame.url);
            fabricFrameSelect.add(option);
        });
    }
    populateFrames();

    // --- Fabric.js Logic ---
    let fabricCanvas, fabricUserImage = null, fabricFrameImage = null, fabricText = null;
    let currentFontFamily = '"Ms Madi"';
    let customFontCounter = 0;
    
    function initFabric() {
        const fabricCanvasEl = document.getElementById('fabricCanvas');
        const canvasWrapper = document.getElementById('canvas-wrapper');
        
        canvasWrapper.style.aspectRatio = '1 / 1'; // Default to square

        fabricCanvas = new fabric.Canvas('fabricCanvas', { 
            backgroundColor: '#E2E8F0' 
        });

        const fabricImageLoader = document.getElementById('fabric-image-loader');
        const fabricTextInput = document.getElementById('fabric-text-input');
        const fabricZoomSlider = document.getElementById('fabric-zoom-slider');
        const fabricXSlider = document.getElementById('fabric-x-slider');
        const fabricYSlider = document.getElementById('fabric-y-slider');
        const fabricZoomValue = document.getElementById('fabric-zoom-value');
        const fabricTextSizeSlider = document.getElementById('fabric-text-size-slider');
        const fabricTextXSlider = document.getElementById('fabric-text-x-slider');
        const fabricTextYSlider = document.getElementById('fabric-text-y-slider');
        const fabricTextSizeValue = document.getElementById('fabric-text-size-value');

        function resizeCanvasAndElements() {
            const newWidth = canvasWrapper.clientWidth;
            const newHeight = canvasWrapper.clientHeight;
            fabricCanvas.setWidth(newWidth);
            fabricCanvas.setHeight(newHeight);

            if (fabricUserImage) {
                const fitScale = Math.min(fabricCanvas.width / fabricUserImage.width, fabricCanvas.height / fabricUserImage.height);
                fabricUserImage.fitScale = fitScale;
                updateFabricImage();
            }
            if (fabricFrameImage) {
                const scale = Math.min(fabricCanvas.width / fabricFrameImage.width, fabricCanvas.height / fabricFrameImage.height);
                fabricFrameImage.scale(scale);
                fabricFrameImage.center();
            }
            if (fabricText) {
                const textXRange = Math.round(newWidth / 2);
                fabricTextXSlider.min = -textXRange;
                fabricTextXSlider.max = textXRange;
                const textYRange = Math.round(newHeight / 2);
                fabricTextYSlider.min = -textYRange;
                fabricTextYSlider.max = textYRange;
                fabricText.center();
            }
            fabricCanvas.renderAll();
        }

        resizeCanvasAndElements();

        function setFabricImageSlidersEnabled(enabled) {
            fabricZoomSlider.disabled = !enabled;
            fabricXSlider.disabled = !enabled;
            fabricYSlider.disabled = !enabled;
        }
        
        function setFabricTextSlidersEnabled(enabled) {
            fabricTextSizeSlider.disabled = !enabled;
            fabricTextXSlider.disabled = !enabled;
            fabricTextYSlider.disabled = !enabled;
        }

        function updateFabricImage() {
            if (!fabricUserImage) return;

            const sliderZoom = parseInt(fabricZoomSlider.value) / 100;
            fabricZoomValue.textContent = fabricZoomSlider.value;
            
            const newScale = fabricUserImage.fitScale * sliderZoom;
            fabricUserImage.scale(newScale);

            const panX = parseInt(fabricXSlider.value) / 100;
            const panY = parseInt(fabricYSlider.value) / 100;
            
            const scaledWidth = fabricUserImage.getScaledWidth();
            const scaledHeight = fabricUserImage.getScaledHeight();
            const canvasWidth = fabricCanvas.width;
            const canvasHeight = fabricCanvas.height;

            const offsetX = Math.max(0, scaledWidth - canvasWidth);
            const offsetY = Math.max(0, scaledHeight - canvasHeight);

            const finalPanX = (panX - 0.5) * offsetX;
            const finalPanY = (panY - 0.5) * offsetY;

            fabricUserImage.left = (canvasWidth / 2) - finalPanX;
            fabricUserImage.top = (canvasHeight / 2) - finalPanY;
            
            fabricCanvas.renderAll();
        }

        document.getElementById('fabric-image-loader-btn').addEventListener('click', () => fabricImageLoader.click());
        fabricImageLoader.addEventListener('change', (e) => {
            if (!e.target.files.length) return;
            const url = URL.createObjectURL(e.target.files[0]);
            fabric.Image.fromURL(url, (img) => {
                if (fabricUserImage) fabricCanvas.remove(fabricUserImage);
                fabricUserImage = img;
                fabricUserImage.set({
                    id: 'userImage',
                    originX: 'center',
                    originY: 'center',
                    selectable: false,
                    evented: false,
                });
                
                const fitScale = Math.min(fabricCanvas.width / img.width, fabricCanvas.height / img.height);
                fabricUserImage.fitScale = fitScale;
                
                fabricZoomSlider.value = 100;
                fabricXSlider.value = 50;
                fabricYSlider.value = 50;
                setFabricImageSlidersEnabled(true);

                fabricCanvas.add(fabricUserImage);
                fabricUserImage.sendToBack();
                updateFabricImage();
            });
        });

        fabricFrameSelect.addEventListener('change', (e) => {
            const url = e.target.value;
            if (fabricFrameImage) {
                fabricCanvas.remove(fabricFrameImage);
                fabricFrameImage = null;
            }
            
            if (!url) {
                canvasWrapper.style.aspectRatio = '1 / 1';
                resizeCanvasAndElements();
                return;
            }

            fabric.Image.fromURL(url, (img) => {
                canvasWrapper.style.aspectRatio = img.width / img.height;
                resizeCanvasAndElements();

                if (fabricFrameImage) fabricCanvas.remove(fabricFrameImage);
                fabricFrameImage = img;
                const scale = Math.min(fabricCanvas.width / img.width, fabricCanvas.height / img.height);
                fabricFrameImage.scale(scale);

                fabricFrameImage.set({ 
                    id: 'frameImage',
                    evented: false, 
                    selectable: false 
                });
                fabricCanvas.add(fabricFrameImage);
                fabricFrameImage.center();
                fabricFrameImage.bringToFront();
                if (fabricText) fabricText.bringToFront();
                fabricCanvas.renderAll();
            }, { crossOrigin: 'anonymous' });
        });

        document.getElementById('fabric-add-text-btn').addEventListener('click', async () => {
            try {
                await document.fonts.ready;

                const newText = fabricTextInput.value;
                if (fabricText) {
                    if (newText) {
                        fabricText.set('text', newText);
                    } else {
                        fabricCanvas.remove(fabricText);
                        fabricText = null;
                        setFabricTextSlidersEnabled(false);
                    }
                } else if (newText) {
                    fabricText = new fabric.Textbox(newText, {
                        id: 'textObject',
                        width: fabricCanvas.width * 0.8,
                        fontSize: 48,
                        fill: '#950000',
                        fontFamily: currentFontFamily,
                        textAlign: 'center',
                        selectable: false,
                        evented: false,
                        originX: 'center',
                        originY: 'center'
                    });
                    fabricCanvas.add(fabricText);
                    
                    fabricText.left = fabricCanvas.width / 2;
                    fabricText.top = fabricCanvas.height / 2;
                    fabricTextXSlider.value = 0;
                    fabricTextYSlider.value = 0;
                    setFabricTextSlidersEnabled(true);
                }
                if (fabricText) fabricText.bringToFront();
                fabricCanvas.renderAll();
            } catch (error) {
                console.error("Font loading error:", error);
                alert("Không thể tải phông chữ, vui lòng làm mới trang và thử lại.");
            }
        });
        
        document.getElementById('fabric-download-btn').addEventListener('click', () => {
            const targetResolution = 2048;
            const currentWidth = fabricCanvas.width;
            const currentHeight = fabricCanvas.height;

            const longestSide = Math.max(currentWidth, currentHeight);
            const multiplier = targetResolution / longestSide;

            const dataURL = fabricCanvas.toDataURL({
                format: 'png',
                quality: 1,
                multiplier: multiplier
            });
            const link = document.createElement('a');
            link.download = 'my-fabric-creation.png';
            link.href = dataURL;
            link.click();
        });

        fabricZoomSlider.addEventListener('input', updateFabricImage);
        fabricXSlider.addEventListener('input', updateFabricImage);
        fabricYSlider.addEventListener('input', updateFabricImage);

        fabricTextSizeSlider.addEventListener('input', (e) => {
            if (!fabricText) return;
            const size = parseInt(e.target.value);
            fabricTextSizeValue.textContent = size;
            fabricText.set('fontSize', size);
            fabricCanvas.renderAll();
        });
        fabricTextXSlider.addEventListener('input', (e) => {
            if (!fabricText) return;
            fabricText.left = (fabricCanvas.width / 2) + parseInt(e.target.value);
            fabricCanvas.renderAll();
        });
        fabricTextYSlider.addEventListener('input', (e) => {
            if (!fabricText) return;
            fabricText.top = (fabricCanvas.height / 2) + parseInt(e.target.value);
            fabricCanvas.renderAll();
        });

        window.addEventListener('resize', () => {
            resizeCanvasAndElements();
        });

        // --- Share & Load Logic ---
        const shareBtn = document.getElementById('share-btn');
        const shareModal = document.getElementById('share-modal');
        const shareLinkInput = document.getElementById('share-link-input');
        const copyLinkBtn = document.getElementById('copy-link-btn');
        const shareModalClose = document.getElementById('share-modal-close');

        shareBtn.addEventListener('click', () => {
            const json = fabricCanvas.toJSON(['id', 'fitScale']);
            const jsonString = JSON.stringify(json);
            const encodedData = btoa(jsonString);
            const url = `${window.location.origin}${window.location.pathname}#data=${encodedData}`;
            shareLinkInput.value = url;
            showModal(shareModal);
        });

        copyLinkBtn.addEventListener('click', () => {
            shareLinkInput.select();
            document.execCommand('copy');
            copyLinkBtn.textContent = 'Đã sao chép!';
            setTimeout(() => { copyLinkBtn.textContent = 'Sao chép'; }, 2000);
        });

        shareModalClose.addEventListener('click', () => hideModal(shareModal));

        function loadFromHash() {
            if (window.location.hash.startsWith('#data=')) {
                const encodedData = window.location.hash.substring(6);
                try {
                    const jsonString = atob(encodedData);
                    const data = JSON.parse(jsonString);
                    fabricCanvas.loadFromJSON(data, () => {
                        fabricUserImage = fabricCanvas.getObjects().find(o => o.id === 'userImage');
                        fabricFrameImage = fabricCanvas.getObjects().find(o => o.id === 'frameImage');
                        fabricText = fabricCanvas.getObjects().find(o => o.id === 'textObject');
                        
                        if(fabricFrameImage) {
                             canvasWrapper.style.aspectRatio = fabricFrameImage.width / fabricFrameImage.height;
                        }
                        resizeCanvasAndElements();

                        if (fabricUserImage) setFabricImageSlidersEnabled(true);
                        if (fabricText) {
                            setFabricTextSlidersEnabled(true);
                            fabricTextInput.value = fabricText.text;
                        }
                        if (fabricFrameImage) {
                            fabricFrameSelect.value = fabricFrameImage.getSrc();
                        }

                        fabricCanvas.renderAll();
                    });
                    history.pushState("", document.title, window.location.pathname + window.location.search);
                } catch (e) {
                    console.error("Không thể tải dữ liệu từ URL:", e);
                }
            }
        }
        loadFromHash();
    }

    // --- Admin Panel Logic ---
    const adminBtn = document.getElementById('admin-btn');
    const adminControls = document.getElementById('admin-controls');
    const passwordModal = document.getElementById('password-modal');
    const passwordInput = document.getElementById('password-input');
    const passwordError = document.getElementById('password-error');
    const passwordSubmit = document.getElementById('password-submit');
    const passwordCancel = document.getElementById('password-cancel');
    const adminUploadFrameBtn = document.getElementById('admin-upload-frame-btn');
    const adminFrameUploader = document.getElementById('admin-frame-uploader');
    const adminAddLinkBtn = document.getElementById('admin-add-link-btn');
    const linkModal = document.getElementById('link-modal');
    const linkNameInput = document.getElementById('link-name-input');
    const linkUrlInput = document.getElementById('link-url-input');
    const linkError = document.getElementById('link-error');
    const linkSubmit = document.getElementById('link-submit');
    const linkCancel = document.getElementById('link-cancel');
    const adminUploadFontBtn = document.getElementById('admin-upload-font-btn');
    const adminFontUploader = document.getElementById('admin-font-uploader');
    const adminFontSelect = document.getElementById('admin-font-select');

    function populateFonts() {
        adminFontSelect.innerHTML = '';
        availableFonts.forEach(font => {
            const option = new Option(font.name, font.value);
            if (font.value === currentFontFamily) {
                option.selected = true;
            }
            adminFontSelect.add(option);
        });
    }

    function showAdminControls() {
        adminBtn.classList.add('hidden');
        adminControls.classList.remove('hidden');
        adminControls.classList.add('flex');
        populateFonts();
    }

    function showModal(modal) {
        modal.classList.remove('hidden');
        setTimeout(() => modal.classList.remove('opacity-0'), 10);
    }

    function hideModal(modal) {
        modal.classList.add('opacity-0');
        setTimeout(() => modal.classList.add('hidden'), 300);
    }

    if (localStorage.getItem('isAdmin') === 'true') {
        showAdminControls();
    }

    adminBtn.addEventListener('click', () => {
        passwordInput.value = '';
        passwordError.classList.add('hidden');
        showModal(passwordModal);
    });

    passwordCancel.addEventListener('click', () => hideModal(passwordModal));

    passwordSubmit.addEventListener('click', () => {
        if (passwordInput.value === '0000') {
            localStorage.setItem('isAdmin', 'true');
            hideModal(passwordModal);
            showAdminControls();
        } else {
            passwordError.classList.remove('hidden');
        }
    });

    adminUploadFrameBtn.addEventListener('click', () => adminFrameUploader.click());
    adminFrameUploader.addEventListener('change', (e) => {
        if (!e.target.files.length) return;
        const url = URL.createObjectURL(e.target.files[0]);
        const frameName = e.target.files[0].name.replace(/\.[^/.]+$/, "");
        frames.push({ name: frameName, url: url });
        populateFrames();
        fabricFrameSelect.value = url;
        fabricFrameSelect.dispatchEvent(new Event('change'));
    });

    adminAddLinkBtn.addEventListener('click', () => {
        linkNameInput.value = '';
        linkUrlInput.value = '';
        linkError.classList.add('hidden');
        showModal(linkModal);
    });
    
    linkCancel.addEventListener('click', () => hideModal(linkModal));

    linkSubmit.addEventListener('click', () => {
        const name = linkNameInput.value.trim();
        const url = linkUrlInput.value.trim();
        if (!name || !url) {
            linkError.classList.remove('hidden');
            return;
        }
        frames.push({ name: name, url: url });
        populateFrames();
        fabricFrameSelect.value = url;
        fabricFrameSelect.dispatchEvent(new Event('change'));
        hideModal(linkModal);
    });

    adminUploadFontBtn.addEventListener('click', () => adminFontUploader.click());
    adminFontUploader.addEventListener('change', async (e) => {
        if (!e.target.files.length) return;
        const fontUrl = URL.createObjectURL(e.target.files[0]);
        const fontName = e.target.files[0].name.replace(/\.[^/.]+$/, "");
        customFontCounter++;
        const fontFamilyName = `CustomFont${customFontCounter}`;
        
        const customFont = new FontFace(fontFamilyName, `url(${fontUrl})`);
        try {
            await customFont.load();
            document.fonts.add(customFont);
            
            const newFont = { name: fontName, value: `"${fontFamilyName}"`};
            availableFonts.push(newFont);
            populateFonts();
            adminFontSelect.value = newFont.value;
            adminFontSelect.dispatchEvent(new Event('change'));
            
            alert(`Đã tải và áp dụng font: ${fontName}`);
        } catch(err) {
            console.error("Lỗi tải font tùy chỉnh:", err);
            alert("Không thể tải tệp font này.");
        }
    });

    adminFontSelect.addEventListener('change', (e) => {
        currentFontFamily = e.target.value;
        if (fabricText) {
            fabricText.set('fontFamily', currentFontFamily);
            fabricCanvas.renderAll();
        }
    });

    // --- Initial Setup ---
    initFabric();
});
</script>

</body>
</html>

